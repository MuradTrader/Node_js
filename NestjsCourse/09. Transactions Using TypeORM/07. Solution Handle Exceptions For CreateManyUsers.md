## üéØ **–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

### ‚ùå **–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–¥–∞:**

```typescript
public async createMany(createManyUsersDto: CreateManyUsersDto) {
    const queryRunner = this.dataSource.createQueryRunner();
    await queryRunner.connect(); // ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
    await queryRunner.startTransaction(); // ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

    let newUsers: User[] = [];
    try {
        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞...
        await queryRunner.commitTransaction();
    } catch (error) {
        await queryRunner.rollbackTransaction(); // ‚ùå –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
        throw error;
    } finally {
        await queryRunner.release(); // ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
    }
}
```

## üîß **–®–∞–≥ 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

### üõ°Ô∏è **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ try-catch –¥–ª—è connect() –∏ startTransaction():**

```typescript
const queryRunner = this.dataSource.createQueryRunner();

try {
  // ‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
  await queryRunner.connect();
  // ‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê–ß–ê–õ–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
  await queryRunner.startTransaction();
} catch (error) {
  // ‚ùå –ù–ï –£–î–ê–õ–û–°–¨ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ò–õ–ò –ù–ê–ß–ê–¢–¨ –¢–†–ê–ù–ó–ê–ö–¶–ò–Æ
  throw new RequestTimeoutException("Could not connect to the database", {
    description: JSON.stringify(error),
  });
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**

- `connect()` –º–æ–∂–µ—Ç fail –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é –∏–ª–∏ –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- `startTransaction()` –º–æ–∂–µ—Ç fail –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ –ë–î
- –ù—É–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞–Ω–Ω–µ–º —ç—Ç–∞–ø–µ

## üîß **–®–∞–≥ 2: –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

### üõ°Ô∏è **–£–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ catch-–±–ª–æ–∫–∞:**

```typescript
try {
  // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
  await queryRunner.commitTransaction();
} catch (error) {
  // ‚úÖ –ü–ï–†–í–û–ï - –û–¢–ö–ê–¢ –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
  await queryRunner.rollbackTransaction();

  // ‚úÖ –í–¢–û–†–û–ï - –ò–ù–§–û–†–ú–ê–¢–ò–í–ù–û–ï –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï
  throw new ConflictException(
    "Could not complete the transaction", // –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    { description: JSON.stringify(error) } // –î–µ—Ç–∞–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
  );
}
```

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**

- `ConflictException` –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ `throw error` - –±–æ–ª–µ–µ —Å–µ–º–∞–Ω—Ç–∏—á–Ω–æ
- JSON.stringify(error) - –ø–µ—Ä–µ–¥–∞—á–∞ –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –¥–µ—Ç–∞–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

## üîß **–®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**

### üõ°Ô∏è **–í–ª–æ–∂–µ–Ω–Ω—ã–π try-catch –≤ finally-–±–ª–æ–∫–µ:**

```typescript
finally {
    try {
        // ‚úÖ –ü–û–ü–´–¢–ö–ê –û–°–í–û–ë–û–î–ò–¢–¨ –°–û–ï–î–ò–ù–ï–ù–ò–ï
        await queryRunner.release();
    } catch (error) {
        // ‚ùå –ù–ï –£–î–ê–õ–û–°–¨ –û–°–í–û–ë–û–î–ò–¢–¨ –°–û–ï–î–ò–ù–ï–ù–ò–ï
        throw new RequestTimeoutException(
            'Could not release the connection',
            { description: JSON.stringify(error) }
        );
    }
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:**

- –ë–µ–∑ release() —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ "–∑–∞–≤–∏—Å–∞–µ—Ç" –≤ –ø—É–ª–µ
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –°–µ—Ä—å–µ–∑–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è production-—Å–∏—Å—Ç–µ–º

## üìä **–ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

### üèóÔ∏è **–ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

```typescript
public async createMany(createManyUsersDto: CreateManyUsersDto) {
    // 1. –°–û–ó–î–ê–ù–ò–ï QUERY RUNNER
    const queryRunner = this.dataSource.createQueryRunner();

    // 2. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï + –ù–ê–ß–ê–õ–û –¢–†–ê–ù–ó–ê–ö–¶–ò–ò (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
    try {
        await queryRunner.connect();
        await queryRunner.startTransaction();
    } catch (error) {
        throw new RequestTimeoutException('Could not connect to the database', ...);
    }

    let newUsers: User[] = [];

    // 3. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
    try {
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
        await queryRunner.commitTransaction();
    } catch (error) {
        // –û–¢–ö–ê–¢ + –ò–ù–§–û–†–ú–ê–¢–ò–í–ù–ê–Ø –û–®–ò–ë–ö–ê
        await queryRunner.rollbackTransaction();
        throw new ConflictException('Could not complete the transaction', ...);
    } finally {
        // 4. –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –û–°–í–û–ë–û–ñ–î–ï–ù–ò–ï (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
        try {
            await queryRunner.release();
        } catch (error) {
            throw new RequestTimeoutException('Could not release the connection', ...);
        }
    }

    return newUsers;
}
```

## üéØ **–¢–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ –∏—Ö —Å–µ–º–∞–Ω—Ç–∏–∫–∞**

### ‚ö° **RequestTimeoutException:**

```typescript
throw new RequestTimeoutException(
  "Could not connect to the database", // –°–æ–æ–±—â–µ–Ω–∏–µ
  { description: JSON.stringify(error) } // –î–µ—Ç–∞–ª–∏
);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î, —Å–µ—Ç–µ–≤—ã–µ issues

### ‚ö° **ConflictException:**

```typescript
throw new ConflictException(
  "Could not complete the transaction", // –°–æ–æ–±—â–µ–Ω–∏–µ
  { description: JSON.stringify(error) } // –î–µ—Ç–∞–ª–∏
);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û—à–∏–±–∫–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üîç **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö**

### ‚úÖ **–£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:**

```
connect() ‚Üí success
startTransaction() ‚Üí success
create users ‚Üí success
commitTransaction() ‚Üí success
release() ‚Üí success
‚Üí RETURN users
```

### ‚ùå **–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**

```
connect() ‚Üí FAIL
‚Üí throw RequestTimeoutException
```

### ‚ùå **–û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**

```
connect() ‚Üí success
startTransaction() ‚Üí success
create users ‚Üí FAIL on 3rd user
rollbackTransaction() ‚Üí success
‚Üí throw ConflictException
```

### ‚ùå **–û—à–∏–±–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:**

```
connect() ‚Üí success
startTransaction() ‚Üí success
create users ‚Üí success
commitTransaction() ‚Üí success
release() ‚Üí FAIL
‚Üí throw RequestTimeoutException
```

## üõ°Ô∏è **–ü—Ä–∏–Ω—Ü–∏–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –æ—Ç –∞–≤—Ç–æ—Ä–∞**

### 1. **"Fail Fast"** - –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –ø—Ä–∏ –ø–µ—Ä–≤—ã—Ö –∂–µ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### 2. **"Resource Cleanup"** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### 3. **"Informative Errors"** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 4. **"Semantic Exceptions"** - –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π

## üìù **–ò–º–ø–æ—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**

```typescript
import { ConflictException, RequestTimeoutException } from "@nestjs/common";
```

## üéØ **–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**

1. ‚úÖ **–†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º** —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
2. ‚úÖ **–°–µ–º–∞–Ω—Ç–∏—á–Ω—ã–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
3. ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —á–µ—Ä–µ–∑ description
4. ‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–µ–∫** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—É–ª–µ

–≠—Ç–æ production-ready –ø–æ–¥—Ö–æ–¥ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö! üöÄ
